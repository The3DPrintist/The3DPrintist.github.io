<!DOCTYPE html>
<html>

<head>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3" crossorigin="anonymous">
  <link rel="stylesheet" href="../../style.css">
  <title>Random Imgur</title>
  <meta name="referrer" content="no-referrer">
</head>

<body>
  
<div class="margin">
  <h1>Random Imgur</h1>
  <p>Generates a random image from Imgur. May be NSFW!</p>
  <a href=".." class="btn btn-outline-light" role="button">back to home page</a>
</div>

<wbr>

<div class ="flexbox">

    <div class="flexsection" style="flex: 2; text-align: center;">
        <button class="btn btn-outline-light" onclick="gen();">Generate</button>
    </div>

    <div class="flexsection" style="flex: 1; justify-content: center; align-items: center;">
        <p id="fails" style="margin: 0.1em;">fails: 0</p>
        <p id="fp" style="margin: 0.1em;">fail %: 0</p>
    </div>

</div>

<div class="section" style="overflow: auto">
    <h2 id="output" style="margin: 0.1em;">none</h2>
    <img id="imgout" style="width: 515px;">
</div>

<div class="section" style="text-align: left;">
    <h2>History</h2>
    <div id="history" >

    </div>
</div>


<script src="https://code.jquery.com/jquery-3.7.1.js" integrity="sha256-eKhayi8LEQwp4NKxN+CfCh+3qOVUtJn3QNZ0TciWLP4=" crossorigin="anonymous"></script>
<script type="text/javascript">
    var fails = 0;
    var totalfails = 0;
    var totalwins = 0;
    var image;
    function randomString() {
        var chars = '01234567890ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghiklmnopqrstuvwxyz'; 
        var stringlength = 5; /* could be 6 or 7, but takes forever because there are lots of dead images */
        var text = '';
        for (var i = 0; i < stringlength; i++) {
            var rnum = Math.floor(Math.random() * chars.length);
            text += chars.substring(rnum,rnum+1);
        }
        
        var source = 'https://i.imgur.com/' + text + '.png';
        
        image = new Image();
        $(image).attr('id', "imgout");
        $(image).css("max-width","100%");
        image.onload = function() {
            if (this.width == 161) {
                console.log("fail");
                fails += 1;
                totalfails += 1;

                image = null;
                randomString();
            } else {
                $('#imgout').replaceWith(this);

                //update labels
                totalwins += 1;
                console.log(source);
                $('#fp').text("fail %: " + Math.floor((totalfails/(totalwins+totalfails))*100));
                $('#history').prepend("<p><a href=\"" + source + "\">" + source + "</a></p>");
            }
        };
        image.src = source;

        $('#output').text(text);
        $('#fails').text("fails: " + fails);

    }

    function gen(){
        fails = 0;
        randomString();
    }

    $(document).ready(function() { 
        gen();
    });
</script>


</body>
</html>
